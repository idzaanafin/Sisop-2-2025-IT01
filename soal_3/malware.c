#include <sys/types.h>
#include <sys/stat.h>
#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <errno.h>
#include <unistd.h>
#include <syslog.h>
#include <string.h>
#include <sys/prctl.h>
#include <time.h>
#include <dirent.h>
#include <limits.h>


extern char **environ;

const char *get_target_dir() {
  char cwd[PATH_MAX];
  if (getcwd(cwd, sizeof(cwd)) != NULL) {
      char *target_dir = malloc(strlen(cwd) + 1);
      if (target_dir != NULL) {
          strcpy(target_dir, cwd);
          return target_dir;
      }
  }
  perror("getcwd() or malloc() error");
  return NULL;
}

void create_daemon(){
  // https://stackoverflow.com/questions/17954432/creating-a-daemon-in-linux
  pid_t pid, sid;        // Variabel untuk menyimpan PID

  pid = fork();     // Menyimpan PID dari Child Process

  if (pid < 0) {
    exit(EXIT_FAILURE);
  }

  if (pid > 0) {
    exit(EXIT_SUCCESS);
  }

  umask(0);

  sid = setsid();
  if (sid < 0) {
    exit(EXIT_FAILURE);
  }

  if ((chdir("/")) < 0) {
    exit(EXIT_FAILURE);
  }

  int x;
  for (x = sysconf(_SC_OPEN_MAX); x>=0; x--)
  {
      close (x);
  }

  close(STDIN_FILENO);
  close(STDOUT_FILENO);
  close(STDERR_FILENO);
}

void menyamarkan_process(int argc, char **argv){
  environ = NULL;

  prctl(PR_SET_NAME, "/soal_3", 0, 0, 0);

  if (argc > 0) {
      size_t len = strlen(argv[0]);
      memset(argv[0], 0, len);
      strncpy(argv[0], "/soal_3", len - 1); 
  }

}


void jalankan_lister() {
  const char *target_dir = get_target_dir();
  const char *log_path = "/tmp/test.log";

  FILE *log = fopen(log_path, "a");
  if (log == NULL) exit(EXIT_FAILURE);

  DIR *d;
  struct dirent *dir;
  d = opendir(target_dir);
  if (d) {
    time_t now = time(NULL);
    fprintf(log, "Listing for %s at %s", target_dir, ctime(&now));
    while ((dir = readdir(d)) != NULL) {
      fprintf(log, "%s\n", dir->d_name);
    }
    fprintf(log, "\n");
    closedir(d);
  }

  fclose(log);
}

void buat_child_lister() {
  pid_t child = fork();

  if (child < 0) exit(EXIT_FAILURE);

  if (child == 0) {
    // CHILD PROCESS: menyamar jadi "lister"
    prctl(PR_SET_NAME, "lister", 0, 0, 0);
    jalankan_lister();  
    exit(EXIT_SUCCESS); 
  }
}

int main(int argc, char *argv[]) {
  create_daemon();
  menyamarkan_process(argc, argv);
  while (1) {
    buat_child_lister();
    sleep(60);
  }
  return 0;
}
